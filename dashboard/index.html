<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š å ±åç¾æ³å„€è¡¨æ¿ | æ•™å­¸è¨“ç·´è¨ˆç•«ä¸»æŒäººå·¥ä½œåŠ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(-45deg, #1e1b4b, #4c1d95, #7c3aed, #9d174d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* Loading å‹•ç•« */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #ec4899;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    </style>
</head>
<body class="text-white p-4 sm:p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- æ¨™é¡Œå€å¡Š -->
        <div class="glass-panel rounded-3xl p-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl sm:text-4xl font-black tracking-wide flex items-center gap-3">
                    ğŸ“Š å·¥ä½œåŠå ±åå„€è¡¨æ¿
                </h1>
                <p class="text-white/70 mt-2">å³æ™‚çµ±è¨ˆ Google Sheets æœ€æ–°å ±åç‹€æ³</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <div id="demoBadge" class="hidden flex items-center gap-2 px-4 py-2 rounded-full bg-yellow-500/20 border border-yellow-500/50 text-sm">
                    <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                    <span class="text-yellow-200 font-bold">é è¦½æ¸¬è©¦è³‡æ–™æ¨¡å¼</span>
                </div>
                <button onclick="fetchData()" class="bg-white/10 hover:bg-white/20 border border-white/30 px-6 py-2 rounded-full flex items-center gap-2 transition-all">
                    <span>ğŸ”„ é‡æ–°æ•´ç†</span>
                </button>
            </div>
        </div>

        <!-- è®€å–ä¸­ç•«é¢ -->
        <div id="loading" class="flex flex-col items-center justify-center py-20 glass-panel rounded-3xl">
            <div class="loader mb-4"></div>
            <p class="text-white/80 animate-pulse">æ­£åœ¨å¾ Google Sheets è¼‰å…¥è³‡æ–™...</p>
        </div>

        <!-- éŒ¯èª¤æç¤ºç•«é¢ (é è¨­éš±è—) -->
        <div id="errorPanel" class="hidden flex-col items-center justify-center py-6 px-4 glass-panel rounded-3xl border-2 border-yellow-500/50 bg-yellow-900/20">
            <div class="flex items-center gap-4 mb-4">
                <div class="text-4xl">âš ï¸</div>
                <h2 class="text-xl font-bold text-yellow-300">ç›®å‰ç„¡æ³•é€£ç·šè‡³æ‚¨çš„ Google Sheetsï¼Œå·²ç‚ºæ‚¨è¼‰å…¥ã€Œæ¸¬è©¦è³‡æ–™ã€ä¾›é è¦½ã€‚</h2>
            </div>
            <div class="text-left text-white/90 space-y-2 bg-black/30 p-5 rounded-xl inline-block text-sm sm:text-base w-full max-w-3xl">
                <p class="font-bold text-pink-300 mb-2">ğŸ’¡ ç‚ºä»€éº¼æœƒé€£ç·šå¤±æ•—ï¼Ÿ</p>
                <p>1. <b>é è¦½ç’°å¢ƒé™åˆ¶ï¼š</b> æŸäº›ç·šä¸Šé è¦½å·¥å…·æœƒé˜»æ“‹å¤–éƒ¨ API é€£ç·š (CORS)ã€‚è«‹å°‡æ­¤ HTML æª”æ¡ˆä¸‹è¼‰ä¸¦ç”¨ç€è¦½å™¨é–‹å•Ÿã€‚</p>
                <p>2. <b>Apps Script å°šæœªæ›´æ–°ï¼š</b> å¦‚æœæ‚¨å‰›è²¼ä¸Š `doGet` ç¨‹å¼ç¢¼ï¼Œè«‹å›åˆ° Apps Scriptï¼Œé»æ“Šå³ä¸Šè§’ <b>ã€Œéƒ¨ç½²ã€ > ã€Œç®¡ç†éƒ¨ç½²ä½œæ¥­ã€</b> > <b>ã€Œç·¨è¼¯ (é‰›ç­†åœ–ç¤º)ã€</b> > <b class="text-yellow-300">å°‡ã€Œç‰ˆæœ¬ã€åˆ‡æ›ç‚ºã€Œå»ºç«‹æ–°ç‰ˆæœ¬ã€</b> ä¸¦é»æ“Šéƒ¨ç½²ã€‚</p>
            </div>
        </div>

        <!-- å…§å®¹å€åŸŸ (é è¨­éš±è—ï¼Œè®€å–å®Œç•¢å¾Œé¡¯ç¤º) -->
        <div id="dashboardContent" class="hidden space-y-6">
            
            <!-- æ•¸æ“šç¸½è¦½å°å¡ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="stat-card rounded-2xl p-6 flex items-center gap-4">
                    <div class="text-4xl bg-white/10 p-4 rounded-xl">ğŸ‘¥</div>
                    <div>
                        <p class="text-white/70 text-sm">ç¸½å ±åäººæ•¸</p>
                        <p class="text-3xl font-black" id="totalCount">0</p>
                    </div>
                </div>
                <div class="stat-card rounded-2xl p-6 flex items-center gap-4">
                    <div class="text-4xl bg-white/10 p-4 rounded-xl">ğŸ¢</div>
                    <div>
                        <p class="text-white/70 text-sm">å¯¦é«”åƒèˆ‡äººæ•¸</p>
                        <p class="text-3xl font-black text-pink-400" id="physicalCount">0</p>
                    </div>
                </div>
                <div class="stat-card rounded-2xl p-6 flex items-center gap-4">
                    <div class="text-4xl bg-white/10 p-4 rounded-xl">ğŸŒ</div>
                    <div>
                        <p class="text-white/70 text-sm">ç·šä¸Šåƒèˆ‡äººæ•¸</p>
                        <p class="text-3xl font-black text-cyan-400" id="onlineCount">0</p>
                    </div>
                </div>
                <div class="stat-card rounded-2xl p-6 flex items-center gap-4">
                    <div class="text-4xl bg-white/10 p-4 rounded-xl">ğŸ‘‘</div>
                    <div>
                        <p class="text-white/70 text-sm">è¨ˆç•«ä¸»æŒäººæ•¸</p>
                        <p class="text-3xl font-black text-purple-400" id="directorCount">0</p>
                    </div>
                </div>
            </div>

            <!-- åœ–è¡¨å€ -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- åƒèˆ‡æ–¹å¼åœ“é¤…åœ– -->
                <div class="glass-panel rounded-3xl p-6 flex flex-col items-center">
                    <h2 class="text-xl font-bold mb-4 w-full border-b border-white/20 pb-2">ğŸ’» åƒèˆ‡æ–¹å¼æ¯”ä¾‹</h2>
                    <div class="w-full max-w-[250px] aspect-square relative">
                        <canvas id="modeChart"></canvas>
                    </div>
                </div>

                <!-- èº«åˆ†ç’°åœˆåœ– -->
                <div class="glass-panel rounded-3xl p-6 flex flex-col items-center">
                    <h2 class="text-xl font-bold mb-4 w-full border-b border-white/20 pb-2">ğŸ‘‘ ä¸»æŒäººèº«åˆ†æ¯”ä¾‹</h2>
                    <div class="w-full max-w-[250px] aspect-square relative">
                        <canvas id="directorChart"></canvas>
                    </div>
                </div>

                <!-- è·é¡é•·æ¢åœ– -->
                <div class="glass-panel rounded-3xl p-6 lg:col-span-3">
                    <h2 class="text-xl font-bold mb-4 w-full border-b border-white/20 pb-2">ğŸ©º å ±åè€…è·é¡åˆ†ä½ˆ</h2>
                    <div class="w-full h-[300px] relative">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        // æ‚¨çš„ Apps Script éƒ¨ç½²ç¶²å€
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzILU7NK0kfuwhBbuHxsnl8Ax51l1vrogQi2NFQL8y-t-PlIEiLko9l2z6C-Z3CIlkH/exec';
        
        // åœ–è¡¨å¯¦ä¾‹è®Šæ•¸
        let modeChartInstance = null;
        let directorChartInstance = null;
        let categoryChartInstance = null;

        // å…¨åŸŸ Chart.js è¨­å®š
        Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
        Chart.defaults.font.family = "'Noto Sans TC', sans-serif";

        // è¼‰å…¥è³‡æ–™
        async function fetchData() {
            // åˆ‡æ›ç•«é¢ç‹€æ…‹
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('errorPanel').classList.add('hidden');
            document.getElementById('demoBadge').classList.add('hidden');

            try {
                const response = await fetch(scriptURL, { 
                    method: 'GET',
                    redirect: 'follow'
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                processData(data);
                document.getElementById('dashboardContent').classList.remove('hidden');

            } catch (error) {
                // å°‡ console.error æ”¹ç‚º console.warnï¼Œé¿å…è§¸ç™¼ç´…è‰²éŒ¯èª¤ç•«é¢
                console.warn('Google Sheets é€£ç·šå¤±æ•—ï¼Œè¼‰å…¥å‚™ç”¨æ¸¬è©¦è³‡æ–™ã€‚åŸå› ï¼š', error.message);
                
                // ç™¼ç”ŸéŒ¯èª¤æ™‚é¡¯ç¤ºè­¦å‘Šé¢æ¿ï¼Œä¸¦è¼‰å…¥æ¸¬è©¦è³‡æ–™è®“ç•«é¢ä»å¯æ­£å¸¸é¡¯ç¤º
                document.getElementById('errorPanel').classList.remove('hidden');
                document.getElementById('demoBadge').classList.remove('hidden');
                document.getElementById('demoBadge').classList.add('flex');
                
                const mockData = [
                    {"å ±åæ™‚é–“":"2026/01/01","å§“å":"æ¸¬è©¦è€…A","æ©Ÿæ§‹å":"å¥‡ç¾é†«é™¢","è·ç¨±":"è—¥å¸«","è² è²¬çš„è·é¡":"è—¥äº‹","ç›®å‰æ˜¯å¦æ“”ä»»è¨ˆç•«ä¸»æŒäºº":"æ˜¯","é è¨ˆåƒèˆ‡æ–¹å¼":"å¯¦é«”"},
                    {"å ±åæ™‚é–“":"2026/01/02","å§“å":"æ¸¬è©¦è€…B","æ©Ÿæ§‹å":"æˆå¤§é†«é™¢","è·ç¨±":"è­·ç†å¸«","è² è²¬çš„è·é¡":"è­·ç†","ç›®å‰æ˜¯å¦æ“”ä»»è¨ˆç•«ä¸»æŒäºº":"å¦","é è¨ˆåƒèˆ‡æ–¹å¼":"ç·šä¸Š"},
                    {"å ±åæ™‚é–“":"2026/01/02","å§“å":"æ¸¬è©¦è€…C","æ©Ÿæ§‹å":"å¥‡ç¾é†«é™¢","è·ç¨±":"é†«æª¢å¸«","è² è²¬çš„è·é¡":"é†«äº‹æª¢é©—","ç›®å‰æ˜¯å¦æ“”ä»»è¨ˆç•«ä¸»æŒäºº":"å¦","é è¨ˆåƒèˆ‡æ–¹å¼":"å¯¦é«”"},
                    {"å ±åæ™‚é–“":"2026/01/03","å§“å":"æ¸¬è©¦è€…D","æ©Ÿæ§‹å":"å¥‡ç¾é†«é™¢","è·ç¨±":"é†«å¸«","è² è²¬çš„è·é¡":"å…¶ä»–","ç›®å‰æ˜¯å¦æ“”ä»»è¨ˆç•«ä¸»æŒäºº":"æ˜¯","é è¨ˆåƒèˆ‡æ–¹å¼":"å¯¦é«”"},
                    {"å ±åæ™‚é–“":"2026/01/04","å§“å":"æ¸¬è©¦è€…E","æ©Ÿæ§‹å":"æ¦®æ°‘ç¸½é†«é™¢","è·ç¨±":"ç‡Ÿé¤Šå¸«","è² è²¬çš„è·é¡":"ç‡Ÿé¤Š","ç›®å‰æ˜¯å¦æ“”ä»»è¨ˆç•«ä¸»æŒäºº":"å¦","é è¨ˆåƒèˆ‡æ–¹å¼":"ç·šä¸Š"},
                    {"å ±åæ™‚é–“":"2026/01/04","å§“å":"æ¸¬è©¦è€…F","æ©Ÿæ§‹å":"å¥‡ç¾é†«é™¢","è·ç¨±":"ç‰©ç†æ²»ç™‚å¸«","è² è²¬çš„è·é¡":"ç‰©ç†æ²»ç™‚","ç›®å‰æ˜¯å¦æ“”ä»»è¨ˆç•«ä¸»æŒäºº":"æ˜¯","é è¨ˆåƒèˆ‡æ–¹å¼":"å¯¦é«”"},
                    {"å ±åæ™‚é–“":"2026/01/05","å§“å":"æ¸¬è©¦è€…G","æ©Ÿæ§‹å":"æ–°æ¨“é†«é™¢","è·ç¨±":"è‡¨åºŠå¿ƒç†å¸«","è² è²¬çš„è·é¡":"è‡¨åºŠå¿ƒç†","ç›®å‰æ˜¯å¦æ“”ä»»è¨ˆç•«ä¸»æŒäºº":"å¦","é è¨ˆåƒèˆ‡æ–¹å¼":"ç·šä¸Š"}
                ];
                
                processData(mockData);
                document.getElementById('dashboardContent').classList.remove('hidden');
                
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // è™•ç†è³‡æ–™ä¸¦ç•«åœ–
        function processData(data) {
            const total = data.length;
            const physical = data.filter(r => r['é è¨ˆåƒèˆ‡æ–¹å¼'] === 'å¯¦é«”').length;
            const online = data.filter(r => r['é è¨ˆåƒèˆ‡æ–¹å¼'] === 'ç·šä¸Š').length;
            const directors = data.filter(r => r['ç›®å‰æ˜¯å¦æ“”ä»»è¨ˆç•«ä¸»æŒäºº'] === 'æ˜¯').length;
            const nonDirectors = total - directors;

            // æ›´æ–°ç•«é¢æ•¸å­—
            document.getElementById('totalCount').innerText = total;
            document.getElementById('physicalCount').innerText = physical;
            document.getElementById('onlineCount').innerText = online;
            document.getElementById('directorCount').innerText = directors;

            // çµ±è¨ˆè·é¡åˆ†ä½ˆ
            const categoryCounts = {};
            data.forEach(r => {
                const cat = r['è² è²¬çš„è·é¡'] || 'æœªå¡«å¯«';
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            });
            
            // æ’åºè·é¡
            const sortedCategories = Object.keys(categoryCounts).sort((a, b) => categoryCounts[b] - categoryCounts[a]);
            const categoryValues = sortedCategories.map(cat => categoryCounts[cat]);

            // ç¹ªè£½åœ–è¡¨
            renderCharts(physical, online, directors, nonDirectors, sortedCategories, categoryValues);
        }

        function renderCharts(physical, online, directors, nonDirectors, categoryLabels, categoryData) {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#fff', padding: 20 } } }
            };

            // 1. åƒèˆ‡æ–¹å¼ (Pie)
            if (modeChartInstance) modeChartInstance.destroy();
            modeChartInstance = new Chart(document.getElementById('modeChart'), {
                type: 'pie',
                data: {
                    labels: ['å¯¦é«”åƒèˆ‡', 'ç·šä¸Šåƒèˆ‡'],
                    datasets: [{
                        data: [physical, online],
                        backgroundColor: ['rgba(236, 72, 153, 0.8)', 'rgba(34, 211, 238, 0.8)'],
                        borderColor: 'rgba(255,255,255,0.2)',
                        borderWidth: 2
                    }]
                },
                options: chartOptions
            });

            // 2. ä¸»æŒäººèº«åˆ† (Doughnut)
            if (directorChartInstance) directorChartInstance.destroy();
            directorChartInstance = new Chart(document.getElementById('directorChart'), {
                type: 'doughnut',
                data: {
                    labels: ['æ˜¯è¨ˆç•«ä¸»æŒäºº', 'å¦'],
                    datasets: [{
                        data: [directors, nonDirectors],
                        backgroundColor: ['rgba(167, 139, 250, 0.8)', 'rgba(251, 146, 60, 0.8)'],
                        borderColor: 'rgba(255,255,255,0.2)',
                        borderWidth: 2
                    }]
                },
                options: { ...chartOptions, cutout: '60%' }
            });

            // 3. è·é¡åˆ†ä½ˆ (Bar)
            if (categoryChartInstance) categoryChartInstance.destroy();
            categoryChartInstance = new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'å ±åäººæ•¸',
                        data: categoryData,
                        backgroundColor: 'rgba(192, 38, 211, 0.6)',
                        borderColor: 'rgba(192, 38, 211, 1)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { stepSize: 1, color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        window.onload = fetchData;

    </script>
</body>
</html>
